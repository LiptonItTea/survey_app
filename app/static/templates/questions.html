<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Questions â€” Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --gap:12px;
      --input-height:40px;
      --textarea-height:88px;
      --radius:6px;
      --primary:#1976d2;
      --danger:#d32f2f;
      --muted:#555;
    }

    *{box-sizing:border-box}

    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:24px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border:1px solid #ddd;text-align:left;vertical-align:top}
    form{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:flex-start}
    .create-grid{
      display:grid;
      gap:var(--gap);
      width:100%;
      grid-template-columns: 1fr 1fr 1fr 200px;
      align-items:start;
    }
    @media (max-width:900px){
      .create-grid{ grid-template-columns: 1fr; }
    }

    label{display:flex;flex-direction:column;gap:6px;font-size:0.95rem}
    input[type="text"], input[type="number"], textarea, input[type="search"]{
      padding:8px;border:1px solid #ccc;border-radius:var(--radius);
      font-size:0.95rem;
    }
    input[type="text"], input[type="number"]{
      height:var(--input-height);
    }
    textarea{
      height:var(--textarea-height);
      resize:vertical;
      padding-top:8px;
      padding-bottom:8px;
    }

    button{padding:8px 12px;border-radius:var(--radius);border:0;background:var(--primary);color:white;cursor:pointer}
    .danger{background:var(--danger)}
    .secondary{background:#888}
    .small{font-size:0.9rem;color:var(--muted)}
    .toolbar{display:flex;gap:var(--gap);align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .message{margin-top:10px;color:green}
    .error{color:#b00020}
    .searchBox{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
    .editRow input, .editRow textarea{width:100%}
    .actions button{margin-right:6px}
  </style>
</head>
<body>
  <h1>Questions</h1>

  <!-- CREATE FORM -->
  <div class="toolbar">
    <form id="createForm" class="create-grid" autocomplete="off">
      <label>
        <span>Text</span>
        <textarea id="text" rows="3" required placeholder="Enter question text"></textarea>
      </label>

      <label>
        <span>Multiple Answers?</span>
        <select id="multipleAnswers">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </label>

      <label>
        <span>Survey ID</span>
        <input type="number" id="surveyId" required min="1" />
      </label>

      <div style="grid-column: 1 / -1; display:flex; gap:8px; justify-content:flex-end; margin-top:4px;">
        <button type="submit">Create Question</button>
      </div>
    </form>
  </div>

  <!-- SEARCH BAR -->
  <div class="searchBox">
    <label for="searchInput"><strong>Search:</strong></label>
    <input type="search" id="searchInput" placeholder="Search question text..." style="min-width:220px"/>
    <button id="searchBtn">Find</button>
    <button id="resetBtn" type="button">Reset</button>
  </div>

  <div id="feedback" class="message" role="status" aria-live="polite"></div>

  <table id="questionsTable" aria-describedby="questionsCaption">
    <caption id="questionsCaption" class="small">List of questions</caption>
    <thead>
      <tr>
        <th style="width:6ch">ID</th>
        <th>Text</th>
        <th style="width:12ch">Multiple</th>
        <th style="width:10ch">Survey ID</th>
        <th style="width:18ch">Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const API_BASE = "http://127.0.0.1:8000/api";
const feedback = document.getElementById('feedback');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const resetBtn = document.getElementById('resetBtn');

function showMessage(msg, isError=false){
  feedback.textContent = msg;
  feedback.className = isError ? 'error' : 'message';
  setTimeout(()=>{ feedback.textContent = ''; }, 4000);
}

function escapeHtml(s){ return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'", '&#039;'); }

async function fetchQuestions(query=""){
  try {
    const res = await fetch(`${API_BASE}/questions/`);
    if(!res.ok) throw new Error(`Failed to load (${res.status})`);
    let questions = await res.json();

    if (query) {
      const q = query.toLowerCase();
      questions = questions.filter(x =>
        (x.text ?? '').toLowerCase().includes(q)
      );
    }

    const tbody = document.querySelector('#questionsTable tbody');
    tbody.innerHTML = '';
    questions.forEach(q => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${q.id ?? ''}</td>
        <td>${escapeHtml(q.text)}</td>
        <td>${q.multiple_answers ? 'Yes' : 'No'}</td>
        <td>${q.id_survey ?? ''}</td>
        <td class="actions">
          <button data-id="${q.id}" class="editBtn">Edit</button>
          <button data-id="${q.id}" class="deleteBtn danger">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  } catch (err) {
    showMessage(err.message, true);
  }
}

// CREATE QUESTION
document.getElementById('createForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const text = document.getElementById('text').value.trim();
  const multiple_answers = document.getElementById('multipleAnswers').value === "true";
  const id_survey = parseInt(document.getElementById('surveyId').value, 10);

  const payload = {text: text, multiple_answers: multiple_answers, id_survey: id_survey}

  try {
    const res = await fetch(`${API_BASE}/questions/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>null);
      throw new Error(err?.detail || `Create failed (${res.status})`);
    }
    const created = await res.json();
    showMessage(`Created question (id=${created.id})`);
    e.target.reset();
    await fetchQuestions();
  } catch (err) {
    showMessage(err.message, true);
  }
});

// DELETE QUESTION
document.querySelector('#questionsTable').addEventListener('click', async (ev) => {
  const btn = ev.target.closest('button.deleteBtn');
  if (!btn) return;
  const id = btn.dataset.id;
  if (!confirm(`Delete question #${id}?`)) return;
  try {
    const res = await fetch(`${API_BASE}/questions/${id}`, { method: 'DELETE' });
    if (!res.ok) throw new Error(`Delete failed (${res.status})`);
    showMessage(`Deleted question #${id}`);
    await fetchQuestions(searchInput.value);
  } catch (err) {
    showMessage(err.message, true);
  }
});

// EDIT QUESTION
document.querySelector('#questionsTable').addEventListener('click', async (ev) => {
  const btn = ev.target.closest('button.editBtn');
  if (!btn) return;
  const id = btn.dataset.id;
  const tr = btn.closest('tr');
  if (tr.classList.contains('editRow')) return;

  const [idCell, textCell, multipleCell, surveyCell, actionCell] = tr.children;
  const textVal = textCell.textContent.trim();
  const multipleVal = multipleCell.textContent.trim() === 'Yes';
  // const surveyVal = surveyCell.textContent.trim();

  tr.classList.add('editRow');
  textCell.innerHTML = `<textarea rows="3">${escapeHtml(textVal)}</textarea>`;
  multipleCell.innerHTML = `
    <select>
      <option value="false" ${!multipleVal?'selected':''}>No</option>
      <option value="true" ${multipleVal?'selected':''}>Yes</option>
    </select>`;
  // surveyCell.innerHTML = `<input type="number" value="${escapeHtml(surveyVal)}" min="1" />`;

  actionCell.innerHTML = `
    <button class="saveBtn" data-id="${id}">Save</button>
    <button class="cancelBtn secondary">Cancel</button>`;

  actionCell.querySelector('.saveBtn').addEventListener('click', async () => {
    const newText = textCell.querySelector('textarea').value.trim();
    const newMultiple = multipleCell.querySelector('select').value === "true";
    // const newSurvey = parseInt(surveyCell.querySelector('input').value, 10);

    try {
      const res = await fetch(`${API_BASE}/questions/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ text: newText, multiple_answers: newMultiple })
      });
      if (!res.ok) {
        const err = await res.json().catch(()=>null);
        throw new Error(err?.detail || `Update failed (${res.status})`);
      }
      showMessage(`Updated question #${id}`);
      await fetchQuestions(searchInput.value);
    } catch (err) {
      showMessage(err.message, true);
    }
  });

  actionCell.querySelector('.cancelBtn').addEventListener('click', () => {
    fetchQuestions(searchInput.value);
  });
});

// SEARCH HANDLERS
searchBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  fetchQuestions(searchInput.value.trim());
});
resetBtn.addEventListener('click', ()=>{
  searchInput.value = '';
  fetchQuestions();
});

// initial load
fetchQuestions();
</script>
</body>
</html>
