<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 24px;
      background: #fafafa;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    header a {
      font-size: 1rem;
      color: #1976d2;
      text-decoration: none;
    }
    h1 { margin: 0; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 16px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th { background: #f0f0f0; }

    button {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .danger { background: #d32f2f; color: white; }
    .primary { background: #1976d2; color: white; }
    .secondary { background: #666; color: white; }
    .optional { background: #090; color: white}

    #feedback {
      margin-top: 12px;
      min-height: 20px;
    }
    .error { color: #c00; }
    .success { color: #090; }
  </style>
</head>
<body>

<header>
  <h1 id="greeting">Welcome</h1>
  <a href="/account">Account Settings</a>
</header>

<h2>Your Surveys</h2>

<button class="primary createBtn">New survey</button>

<div id="feedback"></div>

<table id="surveysTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>Solves</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const BASE = "http://localhost:8000";
const API = "http://localhost:8000/api/surveys";
const USER_API = "http://localhost:8000/api/users";
const COMPLETE_API = "http://localhost:8000/api/complete";
const feedback = document.getElementById("feedback");
let user = NaN;

function msg(text, isErr=false) {
  feedback.textContent = text;
  feedback.className = isErr ? "error" : "success";
  setTimeout(() => { feedback.textContent = ""; }, 4000);
}

function escapeHtml(s) {
  return String(s ?? "").replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

async function fetchMySurveys() {
  try {
    const res = await fetch(`${API}/my`, {
      method: "GET",
      credentials: "include"
    });

    if (!res.ok) {
      const d = await res.json().catch(()=>null);
      throw new Error(d?.detail || "Failed to load your surveys");
    }

    const surveys = await res.json();
    for (let i = 0; i < surveys.length; i++) {
      const solves = await get_solves_survey(surveys[i].id);
      surveys[i].solves = solves;
    }
    buildTable(surveys);

  } catch (err) {
    msg(err.message, true);
  }
}

async function get_solves_survey(surveyId) {
  try {
    const res = await fetch(`${COMPLETE_API}/solves/${surveyId}`, {
      method: "GET",
      credentials: "include"
    });

    if (!res.ok) {
      const d = await res.json().catch(()=>null);
      throw new Error(d?.detail || "Failed to load your surveys");
    }

    const data = await res.json();
    return data.count;

  } catch (err) {
    msg(err.message, true);
  }
  return NaN;
}

function buildTable(items) {
  const tbody = document.querySelector("#surveysTable tbody");
  tbody.innerHTML = "";

  for (const s of items) {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${s.id}</td>
      <td>${escapeHtml(s.name)}</td>
      <td>${s.solves}</td>
      <td>
        <button class="primary unloadBtn" data-id="${s.id}">Unload</button>
        <a href="http://localhost:8000/editSurvey/${s.id}">
          <button class="secondary">Edit</button>
        </a>
        <button class="danger deleteBtn" data-id="${s.id}">Delete</button>
        <button class="optional completeBtn" data-id="${s.id}">Complete</button>
      </td>
    `;

    tbody.appendChild(tr);
  }
}

async function fetchUser() {
  try {
    const res = await fetch(`${USER_API}/me`, {
      method: "GET",
      credentials: "include"
    });

    if (!res.ok) throw new Error("Failed to fetch user");

    user = await res.json();
  } catch(e) {
      msg(e.message, true);
  }
}

document.addEventListener("click", async (ev) => {
  //CREATE
  const create = ev.target.closest(".createBtn");
  if (create) {
    try {
      const created = {
        name: "Example name",
        description: "Description",
        id_user_creator: user.id
      };
      const res = await fetch(`${API}`, {
        method: "POST",
        body: JSON.stringify(created),
        headers: {"Content-Type": "application/json"},
        credentials: "include"
      });

      if (!res.ok) throw new Error("Failed to create survey");

      const data = await res.json();

      msg(`Survey #${data.id} created!`);
      fetchMySurveys();
    } catch (e) {
      msg(e.message, true);
    }

    return;
  }
  
  // UNLOAD
  const unload = ev.target.closest(".unloadBtn");
  if (unload) {
    const id = unload.dataset.id;

    location.href = `${COMPLETE_API}/stat/${id}`;
    return;
  }

  // DELETE
  const del = ev.target.closest(".deleteBtn");
  if (del) {
    const id = del.dataset.id;
    if (!confirm(`Delete survey #${id}?`)) return;

    try {
      const res = await fetch(`${API}/${id}`, {
        method: "DELETE",
        credentials: "include"
      });

      if (!res.ok) throw new Error("Failed to delete survey");

      msg(`Survey #${id} deleted`);
      fetchMySurveys();

    } catch (e) {
      msg(e.message, true);
    }
  }

  // COMPLETE
  const com = ev.target.closest(".completeBtn");
  if (com) {
    const id = com.dataset.id;
    
    location.href = `${BASE}/complete/${id}`;
  }
});

fetchMySurveys();
fetchUser().then((data) => {document.getElementById("greeting").textContent =  `Welcome, ${user.nickname}`;});

// optional small greeting; backend should later expose /me endpoint
document.getElementById("greeting").textContent =  `Welcome, `;
</script>

</body>
</html>